<!DOCTYPE html>
<html>
<head>
  <title>Weekly Pay Tracker with Login</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 4px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Weekly Pay Tracker</h1>

  <div id="authSection">
    <h2>Login or Register</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <button onclick="register()">Register</button>
    <p id="authMessage"></p>
  </div>

  <div id="trackerSection" style="display:none;">
    <h2>Enter Hours (Monâ€“Sun)</h2>
    <label>Pay Period (DD/MM/YY - DD/MM/YY): <input id="payPeriod" type="text" placeholder="01/01/25 - 07/01/25"></label><br><br>
    <table>
      <thead>
        <tr>
          <th>Pay Rate</th>
          <th>Monday</th><th>Tuesday</th><th>Wednesday</th><th>Thursday</th>
          <th>Friday</th><th>Saturday</th><th>Sunday</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Base ($13.28)</td>
          <td><input type="number" id="mon_base"></td><td><input type="number" id="tue_base"></td>
          <td><input type="number" id="wed_base"></td><td><input type="number" id="thu_base"></td>
          <td><input type="number" id="fri_base"></td><td><input type="number" id="sat_base"></td>
          <td><input type="number" id="sun_base"></td>
        </tr>
        <tr>
          <td>After 6pm ($16.60)</td>
          <td><input type="number" id="mon_evening"></td><td><input type="number" id="tue_evening"></td>
          <td><input type="number" id="wed_evening"></td><td><input type="number" id="thu_evening"></td>
          <td><input type="number" id="fri_evening"></td><td></td><td></td>
        </tr>
        <tr>
          <td>Saturday ($16.60)</td>
          <td></td><td></td><td></td><td></td><td></td><td><input type="number" id="sat_saturday"></td><td></td>
        </tr>
        <tr>
          <td>Sunday ($19.92)</td>
          <td></td><td></td><td></td><td></td><td></td><td></td><td><input type="number" id="sun_sunday"></td>
        </tr>
      </tbody>
    </table>
    <br>
    <label>Notes for the week:</label><br>
    <textarea id="weeklyNotes" rows="3" cols="50" placeholder="E.g. Took leave Friday..."></textarea><br><br>
    <button onclick="addWeekEntry()">Submit Week</button>
    <button onclick="logout()">Logout</button>
    <br><br>
    <button onclick="regeneratePDF()">Download This Week's PDF</button>

    <h3>Weekly History</h3>
    <ul id="history"></ul>
    <h3>Average Weekly Total: $<span id="average">0.00</span></h3>
    <input type="hidden" id="lastTotal" value="0">
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBOMK1trQZ5Ybaq11f6nx7_L1_vsdhvQnA",
      authDomain: "pay-tracker-d6145.firebaseapp.com",
      projectId: "pay-tracker-d6145",
      storageBucket: "pay-tracker-d6145.firebasestorage.app",
      messagingSenderId: "915657691207",
      appId: "1:915657691207:web:d13bacb0e6044df875e162",
      measurementId: "G-EE1G4QRWQV"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById("authSection").style.display = "none";
        document.getElementById("trackerSection").style.display = "block";
        loadHistory();
      } else {
        currentUser = null;
        document.getElementById("authSection").style.display = "block";
        document.getElementById("trackerSection").style.display = "none";
      }
    });

    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email, password)
        .catch(err => document.getElementById("authMessage").innerText = err.message);
    }

    function register() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.createUserWithEmailAndPassword(email, password)
        .catch(err => document.getElementById("authMessage").innerText = err.message);
    }

    function logout() {
      auth.signOut();
    }

    function getInput(id) {
      return parseFloat(document.getElementById(id)?.value || 0);
    }

    function calculateTax(income) {
      const threshold = 18200;
      if (income <= threshold) return 0;
      return ((income - threshold) * 0.16) / 52;
    }

    function addWeekEntry() {
      const rate = { base: 13.28, evening: 16.60, saturday: 16.60, sunday: 19.92 };
      const days = ["mon", "tue", "wed", "thu", "fri", "sat", "sun"];
      let total = 0;
      for (const day of days) {
        let base = getInput(`${day}_base`);
        let evening = getInput(`${day}_evening`);
        let sat = getInput(`${day}_saturday`);
        let sun = getInput(`${day}_sunday`);
        let totalHours = base + evening + sat + sun;
        if (totalHours > 8) base = Math.max(0, base - 0.5);
        total += base * rate.base + evening * rate.evening + sat * rate.saturday + sun * rate.sunday;
      }

      const payPeriod = document.getElementById("payPeriod").value;
      const notes = document.getElementById("weeklyNotes").value;
      const annualIncome = total * 52;
      const tax = calculateTax(annualIncome);
      const net = total - tax;

      document.getElementById("lastTotal").value = total;

      db.collection("users").doc(currentUser.uid).collection("entries").add({
        total,
        net,
        tax,
        notes,
        payPeriod,
        timestamp: new Date()
      }).then(() => {
        loadHistory();
        generateWeeklyPDF(total, net, tax, payPeriod, notes);
      });
    }

    function loadHistory() {
      db.collection("users").doc(currentUser.uid).collection("entries")
        .orderBy("timestamp", "desc")
        .get().then(snapshot => {
          const list = document.getElementById("history");
          list.innerHTML = "";
          let total = 0, count = 0;
          snapshot.forEach(doc => {
            const data = doc.data();
            total += data.total;
            count++;
            const li = document.createElement("li");
            li.textContent = `${data.payPeriod || 'Week'}: Gross $${data.total.toFixed(2)} | Net $${data.net?.toFixed(2) || '...'} | Tax $${data.tax?.toFixed(2) || '...'}`;
            list.appendChild(li);
          });
          document.getElementById("average").innerText = (total / count || 0).toFixed(2);
        });
    }

    function generateWeeklyPDF(total, net, tax, weekRange, notes) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("Weekly Pay Summary", 14, 20);
      doc.text(`Pay Period: ${weekRange}`, 14, 30);
      doc.text(`Gross Pay: $${total.toFixed(2)}`, 14, 40);
      doc.text(`Estimated Tax: $${tax.toFixed(2)}`, 14, 50);
      doc.text(`Net Pay: $${net.toFixed(2)}`, 14, 60);
      doc.text("Notes:", 14, 70);
      doc.text(notes || "None", 14, 80);
      doc.save(`Weekly_Pay_Report_${weekRange.replace(/\//g, "-")}.pdf`);
    }

    function regeneratePDF() {
      const total = parseFloat(document.getElementById("lastTotal").value || 0);
      const notes = prompt("Add notes for this week:");
      const weekRange = prompt("Enter pay period (DD/MM/YY - DD/MM/YY):");
      const tax = calculateTax(total * 52);
      const net = total - tax;
      generateWeeklyPDF(total, net, tax, weekRange, notes || "");
    }
  </script>
</body>
</html>
